<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Football Matrix - Steuerung</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#0b1220;color:#fff;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;margin:0}
    .card{background:#111;padding:20px;border-radius:12px;width:92%;max-width:420px;text-align:center}
    input{padding:12px;border-radius:8px;border:1px solid #333;width:100%;box-sizing:border-box;margin-bottom:10px;font-size:18px}
    button{padding:12px 16px;border-radius:8px;border:none;font-size:18px;cursor:pointer;margin-top:6px}
    .small{font-size:13px;opacity:.8;margin-top:8px}
    .grid-btns{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px}
    .grid-btns button{padding:18px;font-size:20px}
    hr{margin:16px 0; border-color:#444;}
  </style>
</head>
<body>
  <div class="card">
    <h2>Steuerung</h2>
    <p>Session Code:</p>
    <input id="code" placeholder="6-stelliger Code" maxlength="6" />
    <div>
      <button onclick="join()">Verbinden</button>
    </div>

    <div id="controls" style="display:none;margin-top:12px">
      <div class="grid-btns">
        <button onclick="manualPick(1)">1</button>
        <button onclick="manualPick(2)">2</button>
        <button onclick="manualPick(3)">3</button>
        <button onclick="manualPick(4)">4</button>
        <button onclick="manualPick(5)">5</button>
        <button onclick="manualPick(6)">6</button>
        <button onclick="manualPick(7)">7</button>
        <button onclick="manualPick(8)">8</button>
        <button onclick="manualPick(9)">9</button>
      </div>

      <div class="small">Letztes Feld: <span id="last">—</span></div>
    </div>

    <hr>

    <!-- Automatisierte Sequenz -->
    <h3>Automatische Sequenz</h3>
    Sequenz Länge: <input id="seqLength" type="number" value="20" min="1" /><br/>
    Sequenz Geschwindigkeit (s): <input id="seqSpeed" type="number" value="0.5" min="0.1" step="0.1" /><br/>
    <button onclick="startSequence()">Start Automatische Sequenz</button>
    <div id="seqStatus" class="small"></div>

    <hr>

    <!-- Kompetitiver Modus -->
    <h3>Kompetitiver Modus</h3>
    Spielername: <input id="playerName" type="text" placeholder="Name" /><br/>
    <button onclick="startCompetitive()">Start Competitiv</button>
    <div id="competitiveStatus" class="small"></div>

    <hr>

    <button onclick="showTop3()">Top 3 Zeiten anzeigen</button>
    <div id="top3" class="small" style="margin-top:6px"></div>

    <div id="status" class="small" style="margin-top:8px"></div>
  </div>

  <!-- Socket.IO -->
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script src="firebase-config.js"></script>

  <script>
    const SERVER_URL = 'https://footballmatrix.onrender.com';
    const socket = io(SERVER_URL, { transports: ['websocket','polling'] });

    let session = null;
    let lastField = 0;

    // Automatisierte Sequenz
    let sequenceTimer = null;

    // Kompetitiver Modus
    let competitiveMode = false;
    let competitiveCount = 0;
    let competitiveStart = null;
    const COMPETITIVE_LENGTH = 20;

    // Firebase setup
    const app = firebase.initializeApp(window._FM_FIREBASE_CONFIG);
    const db = firebase.database();

    function join(){
      const code = document.getElementById('code').value.trim();
      if(!/^\d{6}$/.test(code)){ alert('Bitte gib einen 6-stelligen Code ein'); return; }
      session = code;
      document.getElementById('status').textContent = 'Verbunden mit Session ' + session;
      document.getElementById('controls').style.display = 'block';
      socket.emit('join-session', session);
    }

    socket.on('connect', () => { console.log('connected to server', socket.id); });

    socket.on('session-state', (data) => {
      if(!data) return;
      const v = data.lastField || 0;
      lastField = v;
      document.getElementById('last').textContent = v || '—';
    });

    socket.on('field-changed', ({ field }) => {
      lastField = field;
      document.getElementById('last').textContent = field;
    });

    // --- Manuelles Feld auswählen ---
    function manualPick(n){
      if(!session) return alert('Verbinde dich zuerst mit einer Session.');
      socket.emit('pick-field', { sessionCode: session, field: n });

      // Kompetitiver Modus
      if(competitiveMode){
        competitiveCount++;
        if(competitiveCount === 1) competitiveStart = Date.now();

        if(competitiveCount >= COMPETITIVE_LENGTH){
          competitiveMode = false;
          const duration = (Date.now() - competitiveStart)/1000;
          document.getElementById('competitiveStatus').textContent = `Fertig! Zeit: ${duration.toFixed(2)}s`;
          saveCompetitiveResult(document.getElementById('playerName').value.trim(), duration);
        } else {
          document.getElementById('competitiveStatus').textContent = `Felder: ${competitiveCount}/${COMPETITIVE_LENGTH}`;
        }
      }
    }

    // --- Kompetitiver Modus starten ---
    function startCompetitive() {
      const player = document.getElementById('playerName').value.trim();
      if(!player) return alert('Bitte Namen eingeben!');
      if(!session) return alert('Bitte zuerst verbinden!');
      competitiveMode = true;
      competitiveCount = 0;
      competitiveStart = null;
      document.getElementById('competitiveStatus').textContent = `Klicke ${COMPETITIVE_LENGTH} Felder!`;
    }

    // --- Ergebnis speichern ---
    function saveCompetitiveResult(player, duration){
      const ts = Date.now();
      db.ref('competitiv-scores').push({ player, duration, ts })
        .then(()=>console.log(`Ergebnis gespeichert für ${player}: ${duration}s`))
        .catch(err=>console.error('Fehler beim Speichern:', err));
    }

    // --- Automatische Sequenz starten ---
    function startSequence(){
      if(!session) return alert('Bitte zuerst verbinden!');
      const length = parseInt(document.getElementById('seqLength').value) || 20;
      const speed = parseFloat(document.getElementById('seqSpeed').value) || 0.5;
      let count = 0;

      if(sequenceTimer) clearInterval(sequenceTimer);

      sequenceTimer = setInterval(() => {
        count++;
        let next;
        do { next = Math.floor(Math.random()*9)+1 } while(next === lastField);
        manualPick(next);
        document.getElementById('seqStatus').textContent = `Felder: ${count}/${length}`;

        if(count >= length){
          clearInterval(sequenceTimer);
          sequenceTimer = null;
          document.getElementById('seqStatus').textContent = `Sequenz abgeschlossen!`;
        }
      }, speed*1000);
    }

    // --- Top 3 Zeiten anzeigen ---
    function showTop3(){
      db.ref('competitiv-scores').orderByChild('duration').limitToFirst(3).once('value', snapshot => {
        const div = document.getElementById('top3');
        div.innerHTML = '';
        const items = [];
        snapshot.forEach(s => items.push(s.val()));
        items.forEach((item,i)=>{
          div.innerHTML += `${i+1}. ${item.player}: ${item.duration.toFixed(2)}s<br>`;
        });
      });
    }
  </script>
</body>
</html>
