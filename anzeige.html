<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Football Matrix - Anzeige</title>
  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial,Helvetica,sans-serif}
    .top {position:fixed;left:8px;top:8px;z-index:20}
    .session {font-size:18px;padding:8px 12px;border-radius:6px;background:rgba(255,255,255,0.06)}
    .grid {height:100vh;display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:repeat(3,1fr);gap:8px;padding:16px;box-sizing:border-box}
    .cell {display:flex;align-items:center;justify-content:center;border-radius:12px;background:#222;font-size:48px;transition:transform .12s,background .12s}
    .cell.active{background:#ff3b30;transform:scale(1.06)}
    .cell.green{background:#00ff00 !important; transform:scale(1.06);}
  </style>
</head>
<body>
  <div class="top">
    <div class="session" id="sessionInfo">Session: —</div>
  </div>

  <div class="grid" id="grid">
    <div class="cell" data-i="1">1</div>
    <div class="cell" data-i="2">2</div>
    <div class="cell" data-i="3">3</div>
    <div class="cell" data-i="4">4</div>
    <div class="cell" data-i="5">5</div>
    <div class="cell" data-i="6">6</div>
    <div class="cell" data-i="7">7</div>
    <div class="cell" data-i="8">8</div>
    <div class="cell" data-i="9">9</div>
  </div>

  <audio id="beep" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YRAAAAAA"></audio>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const SERVER_URL = 'https://footballmatrix.onrender.com';
    const socket = io(SERVER_URL, { transports: ['websocket','polling'] });

    let sessionCode = localStorage.getItem('fm_session') || null;
    const sessionInfo = document.getElementById('sessionInfo');

    function makeCode(){ return Math.floor(100000 + Math.random()*900000).toString(); }

    function createSession(){
      sessionCode = makeCode();
      localStorage.setItem('fm_session', sessionCode);
      sessionInfo.textContent = 'Session: ' + sessionCode;
      socket.emit('join-session', sessionCode);
    }

    function restoreOrAsk(){
      if(sessionCode){
        sessionInfo.textContent = 'Session: ' + sessionCode + ' (restored)';
        socket.emit('join-session', sessionCode);
        return;
      }
      createSession();
      alert('Session erstellt. Öffne die Steuerung auf deinem Gerät und gib den Code ein:\n\n' + sessionCode);
    }

    function highlightCell(num,color='red'){
      const cells = document.querySelectorAll('.cell');
      cells.forEach(c=>c.classList.remove('active','green'));
      if(num===0) return; // Null = kein Feld
      const el=document.querySelector(`.cell[data-i="${num}"]`);
      if(el){
        if(color==='green'){ el.classList.add('green'); el.classList.remove('active'); }
        else{ el.classList.add('active'); el.classList.remove('green'); }
      }
      // Sound nur für rot
      if(color==='red'){
        const beep = document.getElementById('beep');
        try{ beep.currentTime=0; beep.play(); } catch(e){}
      }
    }

    socket.on('connect',()=>{ console.log('connected to server', socket.id); if(sessionCode) socket.emit('join-session', sessionCode); });

    socket.on('session-state',(data)=>{
      if(!data) return;
      const v = data.lastField || 0;
      const c = data.color || 'red';
      highlightCell(v,c);
    });

    socket.on('field-changed',({field,color})=>{
      highlightCell(field,color||'red');
    });

    restoreOrAsk();
  </script>
</body>
</html>
